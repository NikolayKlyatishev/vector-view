{% extends "base.html" %}

{% block title %}Настройки{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-cog"></i> Настройки</h1>
                <div>
                    <button type="button" class="btn btn-outline-secondary" onclick="loadSettings()">
                        <i class="fas fa-sync"></i> Обновить
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveSettings()">
                        <i class="fas fa-save"></i> Сохранить
                    </button>
                </div>
            </div>

            <!-- Сообщения -->
            <div id="messageContainer" class="mb-4"></div>


            <!-- Форма настроек -->
            <form id="settingsForm">
                <div class="row">
                    <!-- Основные настройки -->
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-database"></i> Основные настройки</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="chromaDbPath" class="form-label">Путь к базе данных Chroma</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="chromaDbPath" name="chroma_db_path" 
                                               placeholder="../.chroma">
                                        <button class="btn btn-outline-secondary" type="button" id="selectFolderBtn">
                                            <i class="fas fa-folder-open me-1"></i>Выбрать папку
                                        </button>
                                        <button class="btn btn-outline-danger" type="button" id="clearFolderBtn" style="display: none;">
                                            <i class="fas fa-times me-1"></i>Очистить
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        <strong>Способы указания папки:</strong><br>
                                        • <strong>Выбор папки:</strong> Нажмите "Выбрать папку" для выбора директории через диалог браузера<br>
                                        • <strong>Ручной ввод:</strong> Введите путь к папке вручную (абсолютный или относительный)<br>
                                        • <strong>Примеры:</strong> <code>../.chroma</code>, <code>/path/to/chroma</code>, <code>C:\data\chroma</code><br>
                                        <small class="text-muted">Примечание: Выбор папки работает в Chrome/Edge. В других браузерах используйте ручной ввод.</small>
                                    </div>
                                    <div id="folderStatus" class="mt-2" style="display: none;"></div>
                                </div>

                                <div class="mb-3">
                                    <label for="collectionName" class="form-label">Имя коллекции</label>
                                    <input type="text" class="form-control" id="collectionName" name="collection_name" 
                                           placeholder="usage-guides">
                                    <div class="form-text">Название коллекции в базе данных Chroma</div>
                                </div>

                                <div class="mb-3">
                                    <label for="embeddingModel" class="form-label">Модель эмбеддингов</label>
                                    <select class="form-select" id="embeddingModel" name="embedding_model">
                                        <option value="sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2">
                                            sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2
                                        </option>
                                        <option value="sentence-transformers/all-MiniLM-L6-v2">
                                            sentence-transformers/all-MiniLM-L6-v2
                                        </option>
                                        <option value="sentence-transformers/all-mpnet-base-v2">
                                            sentence-transformers/all-mpnet-base-v2
                                        </option>
                                        <option value="sentence-transformers/paraphrase-multilingual-mpnet-base-v2">
                                            sentence-transformers/paraphrase-multilingual-mpnet-base-v2
                                        </option>
                                    </select>
                                    <div class="form-text">Модель для генерации векторных представлений текста</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Настройки Flask -->
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-server"></i> Настройки сервера</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="flaskHost" class="form-label">Хост</label>
                                    <input type="text" class="form-control" id="flaskHost" name="flask_host" 
                                           placeholder="0.0.0.0">
                                    <div class="form-text">IP-адрес для привязки сервера</div>
                                </div>

                                <div class="mb-3">
                                    <label for="flaskPort" class="form-label">Порт</label>
                                    <input type="number" class="form-control" id="flaskPort" name="flask_port" 
                                           placeholder="5001" min="1" max="65535">
                                    <div class="form-text">Порт для запуска веб-сервера</div>
                                </div>

                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="flaskDebug" name="flask_debug">
                                        <label class="form-check-label" for="flaskDebug">
                                            Режим отладки
                                        </label>
                                    </div>
                                    <div class="form-text">Включает автоматическую перезагрузку при изменении кода</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Дополнительная информация -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Информация о текущих настройках</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Статус подключения:</h6>
                                        <span id="connectionStatus" class="badge bg-secondary">Проверка...</span>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Количество документов:</h6>
                                        <span id="documentCount" class="badge bg-secondary">-</span>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-12">
                                        <h6>Доступные коллекции:</h6>
                                        <div id="availableCollections" class="mt-2">
                                            <span class="text-muted">Загрузка...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let currentSettings = {};

// Загрузка настроек при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
    checkConnection();
    setupFolderPicker();
});

// Настройка выбора папки
function setupFolderPicker() {
    const selectFolderBtn = document.getElementById('selectFolderBtn');
    const clearFolderBtn = document.getElementById('clearFolderBtn');
    const chromaDbPath = document.getElementById('chromaDbPath');
    const folderStatus = document.getElementById('folderStatus');

    // Обработчик клика по кнопке выбора папки
    selectFolderBtn.addEventListener('click', async function() {
        try {
            // Проверяем поддержку File System Access API
            if ('showDirectoryPicker' in window) {
                const directoryHandle = await window.showDirectoryPicker();
                const folderPath = directoryHandle.name;
                
                // Устанавливаем путь в поле ввода
                chromaDbPath.value = folderPath;
                
                // Показываем кнопку очистки
                clearFolderBtn.style.display = 'inline-block';
                
                // Валидируем папку
                validateFolder(folderPath);
            } else {
                // Fallback для браузеров без поддержки File System Access API
                showMessage('Ваш браузер не поддерживает выбор папки. Введите путь вручную.', 'warning');
            }
        } catch (error) {
            if (error.name !== 'AbortError') {
                showMessage('Ошибка выбора папки: ' + error.message, 'danger');
            }
        }
    });

    // Обработчик очистки выбора
    clearFolderBtn.addEventListener('click', function() {
        chromaDbPath.value = '';
        clearFolderBtn.style.display = 'none';
        folderStatus.style.display = 'none';
    });

    // Обработчик ручного ввода пути
    chromaDbPath.addEventListener('input', function() {
        if (this.value.trim()) {
            clearFolderBtn.style.display = 'inline-block';
            validateFolder(this.value);
        } else {
            clearFolderBtn.style.display = 'none';
            folderStatus.style.display = 'none';
        }
    });
}

// Валидация выбранной папки
async function validateFolder(folderPath) {
    const folderStatus = document.getElementById('folderStatus');
    
    if (!folderPath.trim()) {
        folderStatus.style.display = 'none';
        return;
    }

    try {
        // Показываем индикатор загрузки
        folderStatus.innerHTML = `
            <div class="d-flex align-items-center text-muted">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Проверка...</span>
                </div>
                Проверка папки...
            </div>
        `;
        folderStatus.style.display = 'block';

        // Проверяем папку через API
        const response = await fetch('/api/validate-folder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ folder_path: folderPath })
        });

        const result = await response.json();

        if (response.ok && result.valid) {
            folderStatus.innerHTML = `
                <div class="d-flex align-items-center text-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <span>Папка найдена</span>
                    ${result.collections_count > 0 ? `<span class="badge bg-success ms-2">${result.collections_count} коллекций</span>` : ''}
                </div>
            `;
        } else {
            folderStatus.innerHTML = `
                <div class="d-flex align-items-center text-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span>${result.message || 'Папка не найдена или недоступна'}</span>
                </div>
            `;
        }
    } catch (error) {
        folderStatus.innerHTML = `
            <div class="d-flex align-items-center text-danger">
                <i class="fas fa-times-circle me-2"></i>
                <span>Ошибка проверки папки: ${error.message}</span>
            </div>
        `;
    }
}

// Загрузка текущих настроек
async function loadSettings() {
    try {
        const response = await fetch('/api/settings');
        const settings = await response.json();
        
        if (response.ok) {
            currentSettings = settings;
            populateForm(settings);
            showMessage('Настройки загружены', 'success');
        } else {
            showMessage('Ошибка загрузки настроек: ' + settings.error, 'danger');
        }
    } catch (error) {
        showMessage('Ошибка загрузки настроек: ' + error.message, 'danger');
    }
}

// Заполнение формы данными
function populateForm(settings) {
    document.getElementById('chromaDbPath').value = settings.chroma_db_path || '';
    document.getElementById('collectionName').value = settings.collection_name || '';
    document.getElementById('embeddingModel').value = settings.embedding_model || '';
    document.getElementById('flaskHost').value = settings.flask_host || '';
    document.getElementById('flaskPort').value = settings.flask_port || '';
    document.getElementById('flaskDebug').checked = settings.flask_debug || false;
}

// Сохранение настроек
async function saveSettings() {
    try {
        const formData = new FormData(document.getElementById('settingsForm'));
        const settings = {};
        
        for (let [key, value] of formData.entries()) {
            if (key === 'flask_debug') {
                settings[key] = true;
            } else {
                settings[key] = value;
            }
        }
        
        // Добавляем checkbox отдельно
        settings.flask_debug = document.getElementById('flaskDebug').checked;
        
        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(settings)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            showMessage('Настройки успешно сохранены', 'success');
            currentSettings = settings;
            checkConnection();
        } else {
            showMessage('Ошибка сохранения: ' + (result.error || 'Неизвестная ошибка'), 'danger');
        }
    } catch (error) {
        showMessage('Ошибка сохранения: ' + error.message, 'danger');
    }
}

// Проверка подключения
async function checkConnection() {
    try {
        // Проверяем статус коллекций
        const response = await fetch('/api/collections');
        const collections = await response.json();
        
        if (response.ok) {
            document.getElementById('connectionStatus').textContent = 'Подключено';
            document.getElementById('connectionStatus').className = 'badge bg-success';
            
            // Показываем доступные коллекции
            const collectionsDiv = document.getElementById('availableCollections');
            if (collections.length > 0) {
                collectionsDiv.innerHTML = collections.map(col => 
                    `<span class="badge bg-primary me-1">${col.name} (${col.document_count} документов)</span>`
                ).join('');
            } else {
                collectionsDiv.innerHTML = '<span class="text-muted">Коллекции не найдены</span>';
            }
            
            // Подсчитываем общее количество документов
            const totalDocs = collections.reduce((sum, col) => sum + (col.document_count || 0), 0);
            document.getElementById('documentCount').textContent = totalDocs;
            document.getElementById('documentCount').className = 'badge bg-info';
        } else {
            document.getElementById('connectionStatus').textContent = 'Ошибка подключения';
            document.getElementById('connectionStatus').className = 'badge bg-danger';
            document.getElementById('availableCollections').innerHTML = '<span class="text-danger">Ошибка загрузки коллекций</span>';
        }
    } catch (error) {
        document.getElementById('connectionStatus').textContent = 'Ошибка подключения';
        document.getElementById('connectionStatus').className = 'badge bg-danger';
        document.getElementById('availableCollections').innerHTML = '<span class="text-danger">Ошибка: ' + error.message + '</span>';
    }
}

// Показ сообщений
function showMessage(message, type) {
    const container = document.getElementById('messageContainer');
    container.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Автоматически скрываем через 5 секунд
    setTimeout(() => {
        const alert = container.querySelector('.alert');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 5000);
}
</script>
{% endblock %}
