{% extends "base.html" %}

{% block title %}–í–µ–∫—Ç–æ—Ä—ã - BMK RAG Interface{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>
                <i class="fas fa-project-diagram me-2"></i>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ–∫—Ç–æ—Ä–æ–≤
            </h4>
            <div class="d-flex gap-1">
                <select class="form-select form-select-sm" id="schemaFilter" onchange="loadVectors()" style="width: auto;">
                    <option value="">–í—Å–µ —Å—Ö–µ–º—ã</option>
                    <option value="workflow">Workflow</option>
                    <option value="form">Form</option>
                    <option value="grid">Grid</option>
                    <option value="page">Page</option>
                </select>
                <button class="btn btn-outline-primary btn-sm" onclick="loadVectors()">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="resetView()">
                    <i class="fas fa-expand-arrows-alt"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center py-2">
                <h6 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>2D –í–µ–∫—Ç–æ—Ä–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ
                </h6>
                <div class="d-flex gap-1 align-items-center">
                    <small class="text-muted" id="vectorCount">–ó–∞–≥—Ä—É–∑–∫–∞...</small>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary" onclick="zoomIn()">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="zoomOut()">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="loading" class="loading text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–µ–∫—Ç–æ—Ä–æ–≤...</p>
                </div>
                
                <div id="canvas-container" style="position: relative; width: 100%; height: 500px; overflow: hidden;">
                    <canvas id="vectorCanvas" width="800" height="500" 
                            style="border: 1px solid #dee2e6; cursor: grab;"
                            onmousedown="startPan(event)" 
                            onmousemove="pan(event)" 
                            onmouseup="endPan(event)"
                            onwheel="handleWheel(event)">
                    </canvas>
                    <!-- Tooltip –¥–ª—è –≤–µ–∫—Ç–æ—Ä–æ–≤ -->
                    <div id="vectorTooltip" class="vector-tooltip" style="display: none;">
                        <div class="tooltip-content">
                            <div class="tooltip-header">
                                <strong id="tooltipSchema"></strong>
                                <span class="badge" id="tooltipBadge"></span>
                            </div>
                            <div class="tooltip-body">
                                <div><strong>ID:</strong> <span id="tooltipId"></span></div>
                                <div><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong> <span id="tooltipCoords"></span></div>
                                <div><strong>–î–ª–∏–Ω–∞:</strong> <span id="tooltipLength"></span></div>
                                <div><strong>–£–≥–æ–ª:</strong> <span id="tooltipAngle"></span></div>
                                <div><strong>–§–∞–π–ª:</strong> <span id="tooltipFile"></span></div>
                                <div><strong>–°–º—ã—Å–ª —á–∞–Ω–∫–∞:</strong> <span id="tooltipVector"></span></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="p-2 bg-light">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="small mb-1">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h6>
                            <ul class="list-unstyled small mb-0">
                                <li><i class="fas fa-mouse-pointer me-1"></i> –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –¥–ª—è –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏—è</li>
                                <li><i class="fas fa-mouse me-1"></i> –ö–æ–ª–µ—Å–æ –º—ã—à–∏ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è</li>
                                <li><i class="fas fa-hand-pointer me-1"></i> –ù–∞–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏</li>
                                <li><i class="fas fa-hand-pointer me-1"></i> –ö–ª–∏–∫ –ø–æ —Å—Ç—Ä–µ–ª–∫–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="small mb-1">–õ–µ–≥–µ–Ω–¥–∞</h6>
                            <div class="d-flex flex-wrap gap-1">
                                <span class="badge bg-primary">Workflow</span>
                                <span class="badge bg-success">Form</span>
                                <span class="badge bg-warning">Grid</span>
                                <span class="badge bg-info">Page</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –≤–µ–∫—Ç–æ—Ä–∞ -->
<div class="modal fade" id="vectorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-vector-square me-2"></i>–î–µ—Ç–∞–ª–∏ –≤–µ–∫—Ç–æ—Ä–∞
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="vectorDetails">
                    <!-- –î–µ—Ç–∞–ª–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let vectors = [];
let canvas, ctx;
let scale = 1;
let offsetX = 0;
let offsetY = 0;
let isPanning = false;
let lastPanX = 0;
let lastPanY = 0;
let selectedVector = null;
let tooltip = null;
let hoveredVector = null;

// –¶–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å—Ö–µ–º
const schemaColors = {
    'workflow': '#0d6efd',
    'form': '#198754',
    'grid': '#ffc107',
    'page': '#0dcaf0',
    'default': '#6c757d'
};

document.addEventListener('DOMContentLoaded', function() {
    canvas = document.getElementById('vectorCanvas');
    ctx = canvas.getContext('2d');
    tooltip = document.getElementById('vectorTooltip');
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä canvas
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è tooltip
    canvas.addEventListener('mousemove', handleMouseMove);
    canvas.addEventListener('mouseleave', hideTooltip);
    
    loadVectors();
});

function resizeCanvas() {
    const container = document.getElementById('canvas-container');
    const rect = container.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = 500;
    drawVectors();
}

async function loadVectors() {
    showLoading('loading');
    
    try {
        const schemaFilter = document.getElementById('schemaFilter').value;
        const url = `/api/vectors?limit=200${schemaFilter ? '&schema=' + schemaFilter : ''}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        hideLoading('loading');
        
        if (data.error) {
            showAlert(data.error, 'danger');
            return;
        }
        
        vectors = data.vectors;
        document.getElementById('vectorCount').textContent = `${vectors.length} –≤–µ–∫—Ç–æ—Ä–æ–≤`;
        
        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        normalizeVectors();
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–∏–¥
        resetView();
        
        drawVectors();
    } catch (error) {
        hideLoading('loading');
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–µ–∫—Ç–æ—Ä–æ–≤:', error);
        showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–µ–∫—Ç–æ—Ä–æ–≤: ' + error.message, 'danger');
    }
}

function normalizeVectors() {
    if (vectors.length === 0) return;
    
    // –ù–∞—Ö–æ–¥–∏–º –≥—Ä–∞–Ω–∏—Ü—ã
    let minX = Math.min(...vectors.map(v => v.x));
    let maxX = Math.max(...vectors.map(v => v.x));
    let minY = Math.min(...vectors.map(v => v.y));
    let maxY = Math.max(...vectors.map(v => v.y));
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø—ã
    const padding = 0.1;
    const rangeX = maxX - minX;
    const rangeY = maxY - minY;
    minX -= rangeX * padding;
    maxX += rangeX * padding;
    minY -= rangeY * padding;
    maxY += rangeY * padding;
    
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º canvas
    const canvasWidth = canvas.width - 100; // –û—Ç—Å—Ç—É–ø—ã
    const canvasHeight = canvas.height - 100;
    
    vectors.forEach(vector => {
        vector.normalizedX = ((vector.x - minX) / (maxX - minX)) * canvasWidth + 50;
        vector.normalizedY = ((vector.y - minY) / (maxY - minY)) * canvasHeight + 50;
    });
}

function drawVectors() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
    ctx.save();
    ctx.translate(offsetX, offsetY);
    ctx.scale(scale, scale);
    
    // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É
    drawGrid();
    
    // –†–∏—Å—É–µ–º –≤–µ–∫—Ç–æ—Ä—ã
    vectors.forEach((vector, index) => {
        drawVector(vector, index);
    });
    
    ctx.restore();
}

function drawGrid() {
    ctx.strokeStyle = '#e9ecef';
    ctx.lineWidth = 0.5;
    
    const gridSize = 50;
    const startX = -offsetX / scale;
    const startY = -offsetY / scale;
    const endX = (canvas.width - offsetX) / scale;
    const endY = (canvas.height - offsetY) / scale;
    
    // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
    for (let x = Math.floor(startX / gridSize) * gridSize; x <= endX; x += gridSize) {
        ctx.beginPath();
        ctx.moveTo(x, startY);
        ctx.lineTo(x, endY);
        ctx.stroke();
    }
    
    // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
    for (let y = Math.floor(startY / gridSize) * gridSize; y <= endY; y += gridSize) {
        ctx.beginPath();
        ctx.moveTo(startX, y);
        ctx.lineTo(endX, y);
        ctx.stroke();
    }
}

function drawVector(vector, index) {
    const x = vector.normalizedX;
    const y = vector.normalizedY;
    const schema = vector.metadata?.schema || 'default';
    const color = schemaColors[schema] || schemaColors.default;
    
    // –í—ã—á–∏—Å–ª—è–µ–º –¥–ª–∏–Ω—É –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–∞
    const magnitude = Math.sqrt(vector.x * vector.x + vector.y * vector.y);
    const angle = Math.atan2(vector.y, vector.x);
    
    // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –¥–ª–∏–Ω—É —Å—Ç—Ä–µ–ª–∫–∏
    const arrowLength = Math.min(Math.max(magnitude * 20, 10), 50);
    
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(angle);
    
    // –†–∏—Å—É–µ–º —Å—Ç—Ä–µ–ª–∫—É
    ctx.strokeStyle = color;
    ctx.fillStyle = color;
    ctx.lineWidth = 2;
    
    // –õ–∏–Ω–∏—è —Å—Ç—Ä–µ–ª–∫–∏
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(arrowLength, 0);
    ctx.stroke();
    
    // –ù–∞–∫–æ–Ω–µ—á–Ω–∏–∫ —Å—Ç—Ä–µ–ª–∫–∏
    const headLength = 8;
    const headAngle = Math.PI / 6;
    
    ctx.beginPath();
    ctx.moveTo(arrowLength, 0);
    ctx.lineTo(arrowLength - headLength * Math.cos(headAngle), -headLength * Math.sin(headAngle));
    ctx.moveTo(arrowLength, 0);
    ctx.lineTo(arrowLength - headLength * Math.cos(headAngle), headLength * Math.sin(headAngle));
    ctx.stroke();
    
    // –¢–æ—á–∫–∞ –≤ –Ω–∞—á–∞–ª–µ –≤–µ–∫—Ç–æ—Ä–∞
    ctx.beginPath();
    ctx.arc(0, 0, 3, 0, 2 * Math.PI);
    ctx.fill();
    
    ctx.restore();
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏—è
    vector.hitRadius = 15;
    vector.arrowLength = arrowLength;
    vector.angle = angle;
}

function showVectorDetails(vector) {
    const details = document.getElementById('vectorDetails');
    const metadata = vector.metadata || {};
    
    details.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</h6>
                <table class="table table-sm">
                    <tr><td><strong>X:</strong></td><td>${vector.x.toFixed(4)}</td></tr>
                    <tr><td><strong>Y:</strong></td><td>${vector.y.toFixed(4)}</td></tr>
                    <tr><td><strong>–î–ª–∏–Ω–∞:</strong></td><td>${Math.sqrt(vector.x * vector.x + vector.y * vector.y).toFixed(4)}</td></tr>
                    <tr><td><strong>–£–≥–æ–ª:</strong></td><td>${(Math.atan2(vector.y, vector.x) * 180 / Math.PI).toFixed(2)}¬∞</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ</h6>
                <table class="table table-sm">
                    <tr><td><strong>ID:</strong></td><td><code>${vector.id}</code></td></tr>
                    <tr><td><strong>–°—Ö–µ–º–∞:</strong></td><td><span class="badge bg-primary">${metadata.schema || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</span></td></tr>
                    <tr><td><strong>–°–µ–∫—Ü–∏—è:</strong></td><td>${metadata.section || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td></tr>
                    <tr><td><strong>–§–∞–π–ª:</strong></td><td>${metadata.path ? metadata.path.split('/').pop() : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td></tr>
                </table>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞</h6>
                <div class="bg-light p-3 rounded">
                    <pre class="mb-0 small">${escapeHtml(vector.document_preview)}</pre>
                </div>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('vectorModal'));
    modal.show();
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º
function startPan(event) {
    isPanning = true;
    lastPanX = event.clientX;
    lastPanY = event.clientY;
    canvas.style.cursor = 'grabbing';
}

function pan(event) {
    if (!isPanning) return;
    
    const deltaX = event.clientX - lastPanX;
    const deltaY = event.clientY - lastPanY;
    
    offsetX += deltaX;
    offsetY += deltaY;
    
    lastPanX = event.clientX;
    lastPanY = event.clientY;
    
    // –°–∫—Ä—ã–≤–∞–µ–º tooltip –ø—Ä–∏ –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–∏
    hideTooltip();
    
    drawVectors();
}

function endPan(event) {
    isPanning = false;
    canvas.style.cursor = 'grab';
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º
function handleWheel(event) {
    event.preventDefault();
    
    const zoomFactor = 0.1;
    const mouseX = event.clientX - canvas.getBoundingClientRect().left;
    const mouseY = event.clientY - canvas.getBoundingClientRect().top;
    
    const oldScale = scale;
    scale += event.deltaY > 0 ? -zoomFactor : zoomFactor;
    scale = Math.max(0.1, Math.min(5, scale));
    
    // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∑–∏—Ü–∏–∏ –º—ã—à–∏
    offsetX = mouseX - (mouseX - offsetX) * (scale / oldScale);
    offsetY = mouseY - (mouseY - offsetY) * (scale / oldScale);
    
    // –°–∫—Ä—ã–≤–∞–µ–º tooltip –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏
    hideTooltip();
    
    drawVectors();
}

function zoomIn() {
    scale = Math.min(5, scale * 1.2);
    drawVectors();
}

function zoomOut() {
    scale = Math.max(0.1, scale / 1.2);
    drawVectors();
}

function resetView() {
    scale = 1;
    offsetX = 0;
    offsetY = 0;
    drawVectors();
}

function handleMouseMove(event) {
    if (isPanning) return;
    
    const rect = canvas.getBoundingClientRect();
    const mouseX = (event.clientX - rect.left - offsetX) / scale;
    const mouseY = (event.clientY - rect.top - offsetY) / scale;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–≤–µ–¥–µ–Ω–∞ –ª–∏ –º—ã—à—å –Ω–∞ –∫–∞–∫–æ–π-–ª–∏–±–æ –≤–µ–∫—Ç–æ—Ä
    let foundVector = null;
    for (const vector of vectors) {
        const distance = Math.sqrt((mouseX - vector.normalizedX) ** 2 + (mouseY - vector.normalizedY) ** 2);
        if (distance < vector.hitRadius) {
            foundVector = vector;
            break;
        }
    }
    
    if (foundVector && foundVector !== hoveredVector) {
        hoveredVector = foundVector;
        showTooltip(foundVector, event.clientX, event.clientY);
        canvas.style.cursor = 'pointer';
    } else if (!foundVector && hoveredVector) {
        hoveredVector = null;
        hideTooltip();
        canvas.style.cursor = 'grab';
    } else if (foundVector) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é tooltip
        updateTooltipPosition(event.clientX, event.clientY);
    }
}

function showTooltip(vector, mouseX, mouseY) {
    const metadata = vector.metadata || {};
    const schema = metadata.schema || 'default';
    const magnitude = Math.sqrt(vector.x * vector.x + vector.y * vector.y);
    const angle = Math.atan2(vector.y, vector.x) * 180 / Math.PI;
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ tooltip
    document.getElementById('tooltipSchema').textContent = schema.toUpperCase();
    document.getElementById('tooltipBadge').textContent = schema;
    document.getElementById('tooltipBadge').className = `badge tooltip-badge bg-${getSchemaBadgeClass(schema)}`;
    document.getElementById('tooltipId').textContent = vector.id.substring(0, 8) + '...';
    document.getElementById('tooltipCoords').textContent = `(${vector.x.toFixed(2)}, ${vector.y.toFixed(2)})`;
    document.getElementById('tooltipLength').textContent = magnitude.toFixed(3);
    document.getElementById('tooltipAngle').textContent = `${angle.toFixed(1)}¬∞`;
    document.getElementById('tooltipFile').textContent = metadata.path ? metadata.path.split('/').pop() : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–º—ã—Å–ª —á–∞–Ω–∫–∞
    if (vector.document_preview) {
        const chunkMeaning = interpretChunk(vector.document_preview, vector.metadata);
        document.getElementById('tooltipVector').textContent = chunkMeaning;
    } else {
        document.getElementById('tooltipVector').textContent = '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º tooltip
    tooltip.style.display = 'block';
    updateTooltipPosition(mouseX, mouseY);
}

function updateTooltipPosition(mouseX, mouseY) {
    const rect = canvas.getBoundingClientRect();
    const tooltipRect = tooltip.getBoundingClientRect();
    
    let x = mouseX + 10;
    let y = mouseY - tooltipRect.height - 10;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ tooltip –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
    if (x + tooltipRect.width > window.innerWidth) {
        x = mouseX - tooltipRect.width - 10;
    }
    if (y < 0) {
        y = mouseY + 10;
    }
    
    tooltip.style.left = x + 'px';
    tooltip.style.top = y + 'px';
}

function hideTooltip() {
    tooltip.style.display = 'none';
    hoveredVector = null;
}

function getSchemaBadgeClass(schema) {
    const classes = {
        'workflow': 'primary',
        'form': 'success',
        'grid': 'warning',
        'page': 'info',
        'default': 'secondary'
    };
    return classes[schema] || 'secondary';
}

function interpretChunk(content, metadata) {
    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —á–∞–Ω–∫–∞ –∏ —Å–æ–∑–¥–∞–µ–º —Å–º—ã—Å–ª–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
    const schema = metadata?.schema || 'unknown';
    const path = metadata?.path || '';
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏ —Ñ—Ä–∞–∑—ã
    const keywords = extractKeywords(content);
    const topic = identifyTopic(content, schema);
    const purpose = identifyPurpose(content, schema);
    
    // –°–æ–∑–¥–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
    let description = [];
    
    // –¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    if (schema === 'workflow') {
        description.push("üîß –†–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å");
    } else if (schema === 'form') {
        description.push("üìù –§–æ—Ä–º–∞");
    } else if (schema === 'grid') {
        description.push("üìä –°–µ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö");
    } else if (schema === 'page') {
        description.push("üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞");
    } else {
        description.push("üìã –î–æ–∫—É–º–µ–Ω—Ç");
    }
    
    // –¢–µ–º–∞
    if (topic) {
        description.push(`"${topic}"`);
    }
    
    // –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
    if (purpose) {
        description.push(`(${purpose})`);
    }
    
    // –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (–ø–µ—Ä–≤—ã–µ 3)
    if (keywords.length > 0) {
        const keyWords = keywords.slice(0, 3).join(", ");
        description.push(`–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: ${keyWords}`);
    }
    
    return description.join(" ");
}

function extractKeywords(content) {
    // –ü—Ä–æ—Å—Ç–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
    const words = content.toLowerCase()
        .replace(/[^\w\s]/g, ' ')
        .split(/\s+/)
        .filter(word => word.length > 3)
        .filter(word => !isStopWord(word));
    
    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —á–∞—Å—Ç–æ—Ç—É
    const wordCount = {};
    words.forEach(word => {
        wordCount[word] = (wordCount[word] || 0) + 1;
    });
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —á–∞—Å—Ç–æ—Ç–µ
    return Object.entries(wordCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([word]) => word);
}

function isStopWord(word) {
    const stopWords = [
        'this', 'that', 'with', 'have', 'will', 'from', 'they', 'been', 'were', 'said',
        'each', 'which', 'their', 'time', 'would', 'there', 'could', 'other', 'after',
        'first', 'well', 'also', 'new', 'because', 'any', 'these', 'give', 'day', 'most',
        '—ç—Ç–æ', '—á—Ç–æ', '–¥–ª—è', '–∏–ª–∏', '–∫–∞–∫', '–µ–≥–æ', '–µ–µ', '–∏—Ö', '–±—ã—Ç—å', '–∏–º–µ—Ç—å', '–±—ã–ª',
        '–±—ã–ª–∞', '–±—ã–ª–æ', '–±—ã–ª–∏', '–∫–æ—Ç–æ—Ä—ã–π', '–∫–æ—Ç–æ—Ä–∞—è', '–∫–æ—Ç–æ—Ä–æ–µ', '–∫–æ—Ç–æ—Ä—ã–µ', '–º–æ–∂–µ—Ç',
        '–¥–æ–ª–∂–µ–Ω', '–Ω—É–∂–Ω–æ', '–º–æ–∂–Ω–æ', '–∫–æ–≥–¥–∞', '–≥–¥–µ', '–ø–æ—á–µ–º—É', '–∫–∞–∫–æ–π', '–∫–∞–∫–∞—è', '–∫–∞–∫–æ–µ'
    ];
    return stopWords.includes(word);
}

function identifyTopic(content, schema) {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–º—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∏ —Å—Ö–µ–º—ã
    const lowerContent = content.toLowerCase();
    
    if (schema === 'workflow') {
        if (lowerContent.includes('—Å–æ–∑–¥–∞–Ω–∏–µ') || lowerContent.includes('—Å–æ–∑–¥–∞—Ç—å')) return '–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤';
        if (lowerContent.includes('–Ω–∞—Å—Ç—Ä–æ–π–∫–∞') || lowerContent.includes('–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è')) return '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã';
        if (lowerContent.includes('–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ') || lowerContent.includes('–∑–∞–ø—É—Å–∫')) return '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á';
        if (lowerContent.includes('–æ–±—Ä–∞–±–æ—Ç–∫–∞') || lowerContent.includes('–ø—Ä–æ—Ü–µ—Å—Å')) return '–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö';
    } else if (schema === 'form') {
        if (lowerContent.includes('–ø–æ–ª–µ') || lowerContent.includes('–≤–≤–æ–¥')) return '–ü–æ–ª—è –≤–≤–æ–¥–∞';
        if (lowerContent.includes('–≤–∞–ª–∏–¥–∞—Ü–∏—è') || lowerContent.includes('–ø—Ä–æ–≤–µ—Ä–∫–∞')) return '–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö';
        if (lowerContent.includes('–æ—Ç–ø—Ä–∞–≤–∫–∞') || lowerContent.includes('submit')) return '–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã';
    } else if (schema === 'grid') {
        if (lowerContent.includes('—Å—Ç–æ–ª–±–µ—Ü') || lowerContent.includes('–∫–æ–ª–æ–Ω–∫–∞')) return '–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö';
        if (lowerContent.includes('—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞') || lowerContent.includes('—Ñ–∏–ª—å—Ç—Ä')) return '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏';
        if (lowerContent.includes('–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ') || lowerContent.includes('–ø–æ–∫–∞–∑')) return '–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö';
    } else if (schema === 'page') {
        if (lowerContent.includes('–Ω–∞–≤–∏–≥–∞—Ü–∏—è') || lowerContent.includes('–º–µ–Ω—é')) return '–ù–∞–≤–∏–≥–∞—Ü–∏—è';
        if (lowerContent.includes('–∫–æ–Ω—Ç–µ–Ω—Ç') || lowerContent.includes('—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ')) return '–ö–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã';
        if (lowerContent.includes('–º–∞–∫–µ—Ç') || lowerContent.includes('layout')) return '–ú–∞–∫–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã';
    }
    
    // –û–±—â–∏–µ —Ç–µ–º—ã
    if (lowerContent.includes('api') || lowerContent.includes('–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å')) return 'API –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã';
    if (lowerContent.includes('–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö') || lowerContent.includes('database')) return '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö';
    if (lowerContent.includes('–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å') || lowerContent.includes('user')) return '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å';
    if (lowerContent.includes('–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å') || lowerContent.includes('security')) return '–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å';
    if (lowerContent.includes('–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å') || lowerContent.includes('performance')) return '–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å';
    
    return null;
}

function identifyPurpose(content, schema) {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    const lowerContent = content.toLowerCase();
    
    if (lowerContent.includes('—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ') || lowerContent.includes('guide')) return '—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ';
    if (lowerContent.includes('–ø—Ä–∏–º–µ—Ä') || lowerContent.includes('example')) return '–ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è';
    if (lowerContent.includes('–æ–ø–∏—Å–∞–Ω–∏–µ') || lowerContent.includes('description')) return '–æ–ø–∏—Å–∞–Ω–∏–µ';
    if (lowerContent.includes('–Ω–∞—Å—Ç—Ä–æ–π–∫–∞') || lowerContent.includes('configuration')) return '–Ω–∞—Å—Ç—Ä–æ–π–∫–∞';
    if (lowerContent.includes('—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ') || lowerContent.includes('requirement')) return '—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è';
    if (lowerContent.includes('–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ') || lowerContent.includes('limitation')) return '–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è';
    if (lowerContent.includes('–æ—à–∏–±–∫–∞') || lowerContent.includes('error')) return '–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫';
    if (lowerContent.includes('—Ç–µ—Å—Ç') || lowerContent.includes('test')) return '—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
    
    return '–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
